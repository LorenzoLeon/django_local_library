{% extends "base_generic.html" %}
{% block title %}
<title>Project Detail</title>
{% endblock %}
{% block sidebar %}
<li class="nav-item"><a class="nav-link" href="#inicio">Inicio</a></li>
<li class="nav-item"><a class="nav-link" href="#mapa">Mapa</a></li>
<li class="nav-item"><a class="nav-link" href="#actividades">Actividades</a></li>
<li class="nav-item"><a class="nav-link" href="#contact">Contacto</a></li>
{% endblock %}
{% block content %}
<!-- Project Introduction -->
<section class="about-section text-center" id="inicio"
    style="background:linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 75%, #000 100%),  url({{ project.head_image.url }});background-size: 100% auto; background-repeat: no-repeat;">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-8">
                <h1 class="text-white mx-auto my-0 text-uppercase">{{project.name}} {{project.abr}}</h1>
                <h3 class="text-white-50 mx-auto mt-2 mb-5">{{project.state}}</h3> {% load humanize %}

                <h3 class="text-white text-opacity-75 mx-auto mt-2 mb-5">{{project.hectares|intcomma}}
                    hectárea{{project.hectares|pluralize}} protegidas</h3>
                <p class="text-white">
                    {{project.description}}
                </p>
            </div>
            <!-- <img class="img-fluid" src="{{ project.head_image.url }}" alt="..." /> -->
        </div>
    </div>
</section>
<!-- Mapa -->
<section class="projects-section bg-black" id="mapa">
    <!-- <h1 class=" mx-auto text-uppercase text-center">Mapa interactivo</h1>-->
    <!--<div class="container px-4 px-lg-5">-->
    <!--<div class="row gx-4 gx-lg-5 justify-content-center">     -->
    <center>
        <svg height="750" width="640" id="myplot2"></svg>
        <svg height="250" width="640" id="myplot3"></svg>
    </center>
    {% load static %}
    <script type="module">

        const sjc = await d3.json("{% static 'assets/sjc.json' %}");
        const zonas = topojson.feature(sjc, sjc.objects.zonas);
        const domain_clases = ["Agricultura y Ganadería", "Bosque Maderable", "Bosque Mesófilo", "Bosque no Maderable", "Reservas y Restauración", "Selva Baja", "Urbano"];
        const color_clases = ["#d5a654", "#7B7F33", "#3c916c", "#2E4521", "#33697f", "#23544c", "#4c2354"];


        const plot_sjc = Plot.plot({
            projection: {
                type: "reflect-y",
                domain: zonas
            },
            color: {
                domain: domain_clases,
                range: color_clases
            },
            marks: [
                Plot.geo(zonas, {
                    fill: "clase",
                    title: (d) => `${d.properties.RODAL}${d.properties.clase}\n${d3.format(",.2r")(d.properties.superficie)} ha`,
                    stroke: "black",
                    tip: false,
                    strokeWidth: 1,
                    ariaLabel: "clase",
                })
            ]
        });


        const myplotsvg = document.querySelector("#myplot2");
        myplotsvg.append(plot_sjc);
        const total_ha = d3.sum(zonas.features.map((d)=>d.properties.superficie))

        const plot_sjc_together = Plot.plot({
            color: {
                domain: domain_clases,
                range: color_clases
            },
            x: { label: "→ Área total (ha)" },
            y: { label: "" },
            marginLeft: 200,
            marginRight: 100,
            marks: [
                Plot.barX(
                    zonas,
                    Plot.groupY(
                        {
                            x: "sum",
                            title: (d) => `${d3.format(",.2r")(d3.sum(d))} ha`,
                            ariaLabel: "first",
                        },
                        {
                            fill: "clase",
                            y: "clase",
                            x: "superficie",
                            title: "superficie",
                            sort: { y: "x" },
                            ariaLabel: "clase",
                            tip: false,
                            stroke: "black"
                        },
                    ),
                ),
                Plot.text(
                    zonas,
                    Plot.groupY(
                        {
                            x: "sum",
                            text: (d) => `${d3.format(",.2r")(d3.sum(d))} ha (${d3.format(".0%")(d3.sum(d)/total_ha)})`
                        },
                        {
                            fill: "white",
                            y: "clase",
                            x: "superficie",
                            text: "superficie",
                            sort: { y: "x" },
                            id: "clase",
                            textanchor: "end",
                            dx: 45
                        },
                    ),
                ),
                Plot.ruleX([0]),
                Plot.axisX({ color: "white" }),
                Plot.axisY({ color: "white" })
            ]
        });

        const myplotsvg_together = document.querySelector("#myplot3");
        myplotsvg_together.append(plot_sjc_together);

        d3.select(plot_sjc)
            .selectAll("path")
            // React when the pointer hovers over the path.
            .on("pointerenter", function () {
                d3.select(plot_sjc).selectAll("path").attr("opacity", 0.5).attr("stroke", "black");
                let c = d3.select(this);
                c.attr("opacity", 1).attr("stroke", "white").raise();
                d3.select(plot_sjc_together).selectAll("rect").select(function(){
                    return d3.select(this).attr("aria-label") == c.attr("aria-label") ? null : this;
                }).attr("opacity", .5).attr("stroke", "black");
                d3.select(plot_sjc_together).selectAll("rect").select(function(){
                    return d3.select(this).attr("aria-label") == c.attr("aria-label") ? this : null;
                }).attr("opacity", 1).attr("stroke", "white");
            });
        // Reset the appearance when the pointer leaves the SVG
        d3.select(plot_sjc)
            .on("pointerleave", function () {
                d3.select(plot_sjc).selectAll("path").attr("opacity", 1).attr("stroke", "black");
                d3.select(plot_sjc_together).selectAll("rect").attr("opacity", 1).attr("stroke", "black");
            });


        d3.select(plot_sjc_together)
            .selectAll("rect")
            // React when the pointer hovers over the path.
            .on("pointerenter", function () {
                d3.select(plot_sjc_together).selectAll("rect").attr("opacity", 0.5);
                let c = d3.select(this);
                c.attr("opacity", 1).attr("stroke", "white");
                let title = c.select("title");
                d3.select(plot_sjc).selectAll("path").select(function(){
                    return d3.select(this).attr("aria-label") == c.attr("aria-label") ? null : this;
                }).attr("opacity", .5).attr("stroke", "black");
                d3.select(plot_sjc).selectAll("path").select(function(){
                    return d3.select(this).attr("aria-label") == c.attr("aria-label") ? this : null;
                }).attr("opacity", 1).attr("stroke", "white").raise();
            });
        // Reset the appearance when the pointer leaves the SVG
        d3.select(plot_sjc_together)
            .on("pointerleave", function () {
                d3.select(plot_sjc_together).selectAll("rect").attr("opacity", 1).attr("stroke", "black");
                d3.select(plot_sjc).selectAll("path").attr("opacity", 1).attr("stroke", "black");
            });

    </script>
    <script type="module">

        const us = await d3.json("{% static 'assets/us-counties-10m.json' %}");
        const counties_raw = topojson.feature(us, us.objects.counties);
        const rate = await d3.csv("{% static 'assets/us-county-unemployment.csv' %}");
        const map = new Map(rate.map((d) => [d.id, +d.rate]));
        counties_raw.features.forEach((g) => {
            g.properties.unemployment = map.get(g.id);
        });
        const plot = Plot.plot({
            projection: "albers-usa",
            color: {
                type: "quantile",
                n: 9,
                label: "Unemployment (%)",
                scheme: "blues"
            },
            marks: [
                Plot.geo(counties_raw, {
                    fill: "unemployment",
                    title: (d) => `${d.properties.name} ${d.properties.unemployment}%`,
                    tip: true
                })
            ]
        });
        /*const div = document.querySelector("#myplot");*/
        /*div.append(plot);*/
    </script>

    <!-- </div>-->
    <!--</div> -->
    </div>
</section>
<!-- List de Eventos -->
<section class="contact-section bg-black" id="actividades">
    <div class="container px-4 px-lg-5">
        <h1 class="text-white mx-auto text-uppercase text-center">Actividades y Eventos</h1>
        <p></p><br>
        <div class="row gx-4 gx-lg-5 card-group card-group-scroll">
            {% for mapevent in project.mapevent_set.all %}
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="card px-4">
                    <img class="card-img-top" src="{{ mapevent.mapeventimage_set.first.file.url }}" alt="..." />
                    <div class="card-body text-center">
                        <h4 class="text-uppercase m-0"><a href="{{ mapevent.get_absolute_url }}">{{mapevent.title}}</a>
                        </h4>
                        <hr class="my-4 mx-auto" />
                        <div class="small text-black-50">{{mapevent.description}}</div>
                        <hr class="my-4 mx-auto" />
                        {% if mapevent.mapeventimage_set.first.file.url %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            <p></p><br>
        </div>
    </div>
</section>
{% endblock %}